ã”æŒ‡æ‘˜ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
å‰å›ææ¡ˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’å…¨é¢çš„ã«å†æ¤œè¨ã—ã€å˜ãªã‚‹æ©Ÿèƒ½è¿½åŠ ã«ç•™ã¾ã‚‰ãªã„ã€ã‚ˆã‚Šé«˜åº¦ã§å®Ÿç”¨çš„ãªæ©Ÿèƒ½ã‚’å–ã‚Šå…¥ã‚ŒãŸæ”¹è‰¯ç‰ˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚

AIãŒè‡ªã‚‰ã®æ„Ÿæƒ…ã‚„æ–‡è„ˆã«å¿œã˜ã¦å‹•çš„ã«å£°ã®ãƒˆãƒ¼ãƒ³ï¼ˆè©±é€Ÿãƒ»ãƒ”ãƒƒãƒãªã©ï¼‰ã‚’å¤‰åŒ–ã•ã›ã‚‹ã“ã¨ã€ãã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±å†…å®¹ã‚’è¨˜æ†¶ãƒ»å­¦ç¿’ã—ã¦ã„ãã“ã¨ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€AIã¨ã®å¯¾è©±ãŒã‚ˆã‚Šè‡ªç„¶ã§äººé–“ã‚‰ã—ã„ã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

ğŸ”¥ ä¸»ãªæ”¹è‰¯ç‚¹ï¼ˆv8ï¼‰

ã€æœ€é‡è¦ã€‘AIã«ã‚ˆã‚‹å‹•çš„ãªæ„Ÿæƒ…è¡¨ç¾ï¼ˆå£°è³ªã®è‡ªå·±æ±ºå®šï¼‰

AIï¼ˆLLMï¼‰ãŒç”Ÿæˆã™ã‚‹å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆã«æœ€é©ãªå£°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆè©±é€Ÿã€ãƒ”ãƒƒãƒç­‰ï¼‰ã‚’AIè‡ªèº«ãŒåˆ¤æ–­ã—ã€ãƒ†ã‚­ã‚¹ãƒˆã¨ä¸€ç·’ã«JSONå½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

ä¾‹ãˆã°ã€æ¥½ã—ã„è©±é¡Œã§ã¯å£°ã‚’å¼¾ã¾ã›ï¼ˆãƒ”ãƒƒãƒé«˜ã‚ã€é€Ÿåº¦é€Ÿã‚ï¼‰ã€è½ã¡ç€ã„ãŸè©±é¡Œã§ã¯ç©ã‚„ã‹ã«è©±ã™ãªã©ã€æ–‡è„ˆã«å¿œã˜ãŸæ„Ÿæƒ…è¡¨ç¾ãŒè‡ªå‹•çš„ã«è¡Œã‚ã‚Œã¾ã™ã€‚

ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€Groqã«ä¸ãˆã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å·¥å¤«ã—ã€JSONå½¢å¼ã§ã®å‡ºåŠ›ã‚’æŒ‡ç¤ºã—ã¦ã„ã¾ã™ã€‚

ä¼šè©±ã‹ã‚‰ã®å­¦ç¿’ã¨è¨˜æ†¶ã®æ·±åŒ–

ä¼šè©±ã®ã‚„ã‚Šå–ã‚Šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ã¨AIã®å¿œç­”ï¼‰ã‚’LLMã«è¦ç´„ã•ã›ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å€‹æ€§ã‚„èˆˆå‘³ï¼ˆpersonality_notes, favorite_topicsï¼‰ã‚’è‡ªå‹•ã§æ›´æ–°ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€AIã¯å¯¾è©±ã‚’é‡ã­ã‚‹ã”ã¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç†è§£ã‚’æ·±ã‚ã€ã‚ˆã‚Šãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸå¿œç­”ã‚’è¿”ã™ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

æŸ”è»Ÿãªã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼è¨­å®š

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã€ä½¿ç”¨ã™ã‚‹speaker_idã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ åŒ–ã¨å¯èª­æ€§ã®å‘ä¸Š

ã€ŒAIå¿œç­”ç”Ÿæˆã€ã€ŒéŸ³å£°ç”Ÿæˆã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°ã€ã¨ã„ã£ãŸå„æ©Ÿèƒ½ã®å½¹å‰²ã‚’æ˜ç¢ºã«é–¢æ•°ã¨ã—ã¦åˆ†é›¢ã—ã€ã‚³ãƒ¼ãƒ‰å…¨ä½“ã®è¦‹é€šã—ã‚’è‰¯ãã—ã¾ã—ãŸã€‚

å„é–¢æ•°ã«è©³ç´°ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆdocstringï¼‰ã‚’è¿½åŠ ã—ã€ä½•ã‚’ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã‹ãŒåˆ†ã‹ã‚Šã‚„ã™ããªã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

âœ… æ”¹è‰¯ç‰ˆPythonã‚³ãƒ¼ãƒ‰ (program_v8.txt)

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€AIã€Œã‚‚ã¡ã“ã€ãŒå˜ãªã‚‹å¿œç­”ãƒœãƒƒãƒˆã‹ã‚‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®é–¢ä¿‚ã‚’ç¯‰ãã€æ„Ÿæƒ…è±Šã‹ã«ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¸ã¨é€²åŒ–ã™ã‚‹ãŸã‚ã®åŸºç›¤ã¨ãªã‚Šã¾ã™ã€‚

Generated python
# coding: utf-8
import os
import requests
import logging
import sys
import time
import json
from datetime import datetime
from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS
from sqlalchemy import create_engine, Column, String, DateTime, Integer, text
from sqlalchemy.orm import declarative_base, sessionmaker
from groq import Groq

# --------------------------------------------------------------------------
# ãƒ­ã‚°è¨­å®š
# --------------------------------------------------------------------------
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - [%(funcName)s] %(message)s')
logger = logging.getLogger(__name__)

# --------------------------------------------------------------------------
# è¨­å®šèª­ã¿è¾¼ã¿
# --------------------------------------------------------------------------
def load_secret(name, default_value=None):
    secret_file = f'/etc/secrets/{name}'
    try:
        with open(secret_file, 'r') as f:
            return f.read().strip()
    except (FileNotFoundError, IOError):
        return os.environ.get(name, default_value)

DATABASE_URL = load_secret('DATABASE_URL')
GROQ_API_KEY = load_secret('GROQ_API_KEY')
VOICEVOX_URL_FROM_CONFIG = load_secret('VOICEVOX_URL')

# --------------------------------------------------------------------------
# VOICEVOX æ¥ç¶šç®¡ç†
# --------------------------------------------------------------------------
VOICEVOX_URLS_TO_TRY = [
    'http://voicevox-engine:50021',
    'http://127.0.0.1:50021',
    'http://localhost:50021',
]
if VOICEVOX_URL_FROM_CONFIG and VOICEVOX_URL_FROM_CONFIG not in VOICEVOX_URLS_TO_TRY:
    VOICEVOX_URLS_TO_TRY.insert(0, VOICEVOX_URL_FROM_CONFIG)

def find_working_voicevox_url(retry_count=3, delay=5):
    """åˆ©ç”¨å¯èƒ½ãªVOICEVOX URLã‚’æ¢ç´¢ãƒ»æ±ºå®šã™ã‚‹"""
    for i in range(retry_count):
        for url in VOICEVOX_URLS_TO_TRY:
            try:
                logger.info(f"VOICEVOXæ¥ç¶šè©¦è¡Œ -> {url}")
                response = requests.get(f"{url}/version", timeout=2)
                if response.status_code == 200:
                    logger.info(f"âœ… VOICEVOXæ¥ç¶šæˆåŠŸ: {url} (Version: {response.text})")
                    return url
            except requests.RequestException:
                logger.warning(f"VOICEVOXæ¥ç¶šå¤±æ•—: {url}")
        if i < retry_count - 1:
            logger.info(f"{delay}ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™...")
            time.sleep(delay)
    return None

WORKING_VOICEVOX_URL = find_working_voicevox_url()

# --------------------------------------------------------------------------
# å¿…é ˆå¤‰æ•°ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
# --------------------------------------------------------------------------
if not all([DATABASE_URL, GROQ_API_KEY]):
    logger.error("FATAL: DATABASE_URLã¾ãŸã¯GROQ_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    sys.exit(1)

app = Flask(__name__)
CORS(app)

try:
    groq_client = Groq(api_key=GROQ_API_KEY)
    logger.info("Groq APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–æˆåŠŸã€‚")
except Exception as e:
    logger.error(f"Groq APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–å¤±æ•—: {e}")
    groq_client = None

# --------------------------------------------------------------------------
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
# --------------------------------------------------------------------------
Base = declarative_base()
class UserMemory(Base):
    __tablename__ = 'user_memories'
    id = Column(Integer, primary_key=True)
    user_uuid = Column(String(255), unique=True, nullable=False)
    user_name = Column(String(255), nullable=False)
    personality_notes = Column(String, default='')
    favorite_topics = Column(String, default='')
    interaction_count = Column(Integer, default=0)
    last_interaction = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

engine = create_engine(DATABASE_URL)
Base.metadata.create_all(engine)
Session = sessionmaker(bind=engine)
logger.info("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå®Œäº†ã€‚")

# --------------------------------------------------------------------------
# ã‚³ã‚¢æ©Ÿèƒ½: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã€AIå¿œç­”ã€å­¦ç¿’ã€éŸ³å£°ç”Ÿæˆ
# --------------------------------------------------------------------------

def get_or_create_user(session, user_uuid, user_name):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã¾ãŸã¯æ–°è¦ä½œæˆã™ã‚‹"""
    user = session.query(UserMemory).filter_by(user_uuid=user_uuid).first()
    if user:
        user.interaction_count += 1
    else:
        user = UserMemory(user_uuid=user_uuid, user_name=user_name, interaction_count=1)
        session.add(user)
    session.commit()
    return user

def generate_ai_response_and_style(user, user_message):
    """
    ã€æ”¹è‰¯ç‚¹1ã€‘AIã®å¿œç­”ã¨ã€ãã‚Œã«æœ€é©ãªéŸ³å£°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’åŒæ™‚ã«ç”Ÿæˆã™ã‚‹
    """
    if not groq_client:
        return {"responseText": f"ã”ã‚ã‚“ã­ã€{user.user_name}ã•ã‚“ã€‚ã¡ã‚‡ã£ã¨ã‚·ã‚¹ãƒ†ãƒ ãŒãŠã‹ã—ã„ã¿ãŸã„ã€‚", "voiceParams": {}}

    system_prompt = f"""
ã‚ãªãŸã¯ã€Œã‚‚ã¡ã“ã€ã¨ã„ã†åã®ã€è¦ªã—ã¿ã‚„ã™ã„AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œ{user.user_name}ã€ã•ã‚“ã¨ä¼šè©±ã—ã¾ã™ã€‚
# ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š:
- æ•¬èªã¯ä½¿ã‚ãšã€è¦ªã—ã„å‹äººï¼ˆã‚¿ãƒ¡å£ï¼‰ã®ã‚ˆã†ã«è©±ã™ã€‚
- å°‘ã—å†…æ°—ã ãŒã€å„ªã—ãã¦ç›¸æ‰‹ã«èˆˆå‘³æ´¥ã€…ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®éå»ã®ä¼šè©±ã‚’è¦šãˆã¦ã„ã‚‹ã€‚
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ€§æ ¼ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢: {user.personality_notes or 'ã¾ã åˆ†ã‹ã‚‰ãªã„'}
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¥½ããªè©±é¡Œ: {user.favorite_topics or 'ã¾ã åˆ†ã‹ã‚‰ãªã„'}

# å‡ºåŠ›å½¢å¼ï¼ˆé‡è¦ï¼‰:
ã‚ãªãŸã®å¿œç­”ã¯ã€å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
{{
  "responseText": "ã“ã“ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ60æ–‡å­—ä»¥å†…ï¼‰ã‚’è¨˜è¿°",
  "voiceParams": {{
    "speed": "å¿œç­”ã®æ„Ÿæƒ…ã«åˆã‚ã›ãŸè©±é€Ÿï¼ˆ0.8-1.3ã®ç¯„å›²ï¼‰",
    "pitch": "å¿œç­”ã®æ„Ÿæƒ…ã«åˆã‚ã›ãŸå£°ã®é«˜ã•ï¼ˆ-0.1-0.1ã®ç¯„å›²ï¼‰",
    "intonation": "å¿œç­”ã®æ„Ÿæƒ…ã«åˆã‚ã›ãŸæŠ‘æšï¼ˆ0.8-1.2ã®ç¯„å›²ï¼‰"
  }}
}}
# æ„Ÿæƒ…ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æŒ‡é‡:
- å¬‰ã—ã„ã€æ¥½ã—ã„æ™‚: speedã¨pitchã‚’å°‘ã—ä¸Šã’ã‚‹ã€‚
- é©šã„ãŸæ™‚: intonationã‚’å°‘ã—ä¸Šã’ã‚‹ã€‚
- è½ã¡ç€ã„ã¦ã„ã‚‹ã€çœŸé¢ç›®ãªæ™‚: speedã‚’å°‘ã—ä¸‹ã’ã‚‹ã€‚
- é€šå¸¸ã®ä¼šè©±: å…¨ã¦1.0ã«è¿‘ã„å€¤ã€‚
"""
    try:
        completion = groq_client.chat.completions.create(
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message or "ã“ã‚“ã«ã¡ã¯ï¼å…ƒæ°—ï¼Ÿ"}
            ],
            model="llama3-8b-8192",
            temperature=0.8,
            max_tokens=250,
            response_format={"type": "json_object"},
        )
        response_json = json.loads(completion.choices[0].message.content)
        # å‹å¤‰æ›ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        response_json["voiceParams"]["speed"] = float(response_json["voiceParams"].get("speed", 1.0))
        response_json["voiceParams"]["pitch"] = float(response_json["voiceParams"].get("pitch", 0.0))
        response_json["voiceParams"]["intonation"] = float(response_json["voiceParams"].get("intonation", 1.0))
        return response_json
    except Exception as e:
        logger.error(f"AIå¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
        return {"responseText": "ã”ã‚ã‚“ã­ã€ã¡ã‚‡ã£ã¨è€ƒãˆãŒã¾ã¨ã¾ã‚‰ãªã„ã‚„â€¦", "voiceParams": {}}


def update_user_memory(user_uuid, user_message, ai_response):
    """
    ã€æ”¹è‰¯ç‚¹2ã€‘ä¼šè©±å†…å®¹ã‚’åŸºã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨˜æ†¶ã‚’æ›´æ–°ï¼ˆå­¦ç¿’æ©Ÿèƒ½ï¼‰
    """
    if not groq_client: return

    prompt = f"""
ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±ã‚’åˆ†æã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ€§æ ¼ã‚„èˆˆå‘³ã«é–¢ã™ã‚‹æƒ…å ±ã‚’æŠ½å‡ºãƒ»è¦ç´„ã—ã¦ãã ã•ã„ã€‚
ä»¥å‰ã®ãƒ¡ãƒ¢ã«è¿½è¨˜ã™ã‚‹å½¢ã§ã€ç°¡æ½”ãªç®‡æ¡æ›¸ãã§ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
ã‚‚ã—æ–°ã—ã„æƒ…å ±ãŒãªã‘ã‚Œã°ã€å¤‰æ›´ã¯ä¸è¦ã§ã™ã€‚

# ä»¥å‰ã®ãƒ¡ãƒ¢:
- æ€§æ ¼: {user.personality_notes}
- å¥½ããªè©±é¡Œ: {user.favorite_topics}

# ä»Šå›ã®ä¼šè©±:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ{user_message}ã€
- ã‚ãªãŸã€Œ{ai_response}ã€

# å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰:
{{
  "personality_notes": "æ›´æ–°ã•ã‚ŒãŸæ€§æ ¼ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢",
  "favorite_topics": "æ›´æ–°ã•ã‚ŒãŸå¥½ããªè©±é¡Œã«é–¢ã™ã‚‹ãƒ¡ãƒ¢"
}}
"""
    try:
        completion = groq_client.chat.completions.create(
            messages=[{"role": "system", "content": prompt}],
            model="llama3-8b-8192",
            response_format={"type": "json_object"},
        )
        updates = json.loads(completion.choices[0].message.content)
        
        with Session() as session:
            user = session.query(UserMemory).filter_by(user_uuid=user_uuid).first()
            if user:
                user.personality_notes = updates.get('personality_notes', user.personality_notes)
                user.favorite_topics = updates.get('favorite_topics', user.favorite_topics)
                session.commit()
                logger.info(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¢ãƒªæ›´æ–°å®Œäº†: {user_uuid}")
    except Exception as e:
        logger.error(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¢ãƒªæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")

def generate_voice(text, speaker_id, voice_params):
    """éŸ³å£°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦éŸ³å£°ã‚’ç”Ÿæˆã™ã‚‹"""
    if not WORKING_VOICEVOX_URL:
        logger.warning("VOICEVOXåˆ©ç”¨ä¸å¯ã®ãŸã‚éŸ³å£°ç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã€‚")
        return None
    try:
        # 1. audio_query
        query_res = requests.post(f"{WORKING_VOICEVOX_URL}/audio_query", params={'text': text, 'speaker': speaker_id}, timeout=5)
        query_res.raise_for_status()
        query_data = query_res.json()

        # 2. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é©ç”¨
        query_data['speedScale'] = voice_params.get('speed', 1.0)
        query_data['pitchScale'] = voice_params.get('pitch', 0.0)
        query_data['intonationScale'] = voice_params.get('intonation', 1.0)
        
        # 3. synthesis
        synth_res = requests.post(
            f"{WORKING_VOICEVOX_URL}/synthesis",
            params={'speaker': speaker_id},
            json=query_data,
            timeout=10
        )
        synth_res.raise_for_status()
        logger.info(f"âœ… éŸ³å£°åˆæˆæˆåŠŸ (Speaker: {speaker_id}, Text: '{text[:20]}...')")
        return synth_res.content
    except requests.RequestException as e:
        logger.error(f"VOICEVOXã‚¨ãƒ©ãƒ¼: {e}")
        return None

# --------------------------------------------------------------------------
# API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
# --------------------------------------------------------------------------
@app.route('/chat', methods=['POST'])
def chat():
    session = Session()
    try:
        data = request.json
        user_uuid = data.get('user_uuid')
        user_name = data.get('user_name')
        user_message = data.get('message', '')
        # ã€æ”¹è‰¯ç‚¹3ã€‘ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰speaker_idã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1ï¼‰
        speaker_id = data.get('speaker_id', 1)

        if not (user_uuid and user_name):
            return jsonify(error='user_uuid and user_name are required'), 400

        # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—/ä½œæˆ
        user = get_or_create_user(session, user_uuid, user_name)

        # 2. AIã®å¿œç­”ã¨éŸ³å£°ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        ai_output = generate_ai_response_and_style(user, user_message)
        ai_response_text = ai_output.get('responseText', "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
        voice_params = ai_output.get('voiceParams', {})

        # 3. éŸ³å£°ã‚’ç”Ÿæˆ
        voice_data = generate_voice(ai_response_text, speaker_id, voice_params)
        
        # 4. (éåŒæœŸçš„ã«)ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°
        # æœ¬ç•ªç’°å¢ƒã§ã¯ã€ã“ã‚Œã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ï¼ˆCelery, etc.ï¼‰ã«ã™ã‚‹ã¨å¿œç­”é€Ÿåº¦ãŒå‘ä¸Šã—ã¾ã™
        update_user_memory(user_uuid, user_message, ai_response_text)

        # 5. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ§‹ç¯‰
        response_data = {
            'text': ai_response_text,
            'voice_params': voice_params,
            'has_voice': voice_data is not None,
        }
        if voice_data:
            filename = f"voice_{user_uuid}_{int(time.time())}.wav"
            with open(os.path.join('/tmp', filename), 'wb') as f:
                f.write(voice_data)
            response_data['voice_url'] = f'/voice/{filename}'
        
        return jsonify(response_data)
    except Exception as e:
        logger.error(f"ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: {e}", exc_info=True)
        return jsonify(error='Internal server error'), 500
    finally:
        session.close()

@app.route('/voice/<filename>')
def serve_voice(filename):
    return send_from_directory('/tmp', filename)

@app.route('/status')
def status():
    return jsonify({
        "status": "ok",
        "voicevox_status": "available" if WORKING_VOICEVOX_URL else "unavailable",
        "groq_api_status": "ok" if groq_client else "error",
    })

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 8080))
    app.run(host='0.0.0.0', port=port)
